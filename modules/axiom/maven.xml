<?xml version="1.0" encoding="UTF-8"?>

<!-- $Revision: 1.21 $ $Date: 2004-10-27 20:54:09 +0600 (Wed, 27 Oct 2004) $ -->

<project default="jar"
         xmlns:j="jelly:core"
         xmlns:u="jelly:util"
         xmlns:maven="jelly:maven"
         xmlns:util="jelly:util"
         xmlns:deploy="deploy"
         xmlns:ant="jelly:ant">

        <preGoal name="itest:compile">
        <u:file var="file" name="${maven.itest.src}"/>
        <j:if test="${!file.exists()}">
            <j:expr value="${context.setVariable('maven.itest.skip', 'true')}"/>
        </j:if>
    </preGoal>

    <preGoal name="test:test">
        <copy todir="test-resources">
            <fileset dir="modules/axiom-tests/test-resources"/>
        </copy>
    </preGoal>

    <postGoal name="test:test">
        <delete dir="test-resources"/>
    </postGoal>

    <postGoal name="java:compile">
        <javac destdir="${basedir}/target/classes/" srcdir="${basedir}/modules"
               debug="true"
               source="1.3"
               classpathref="maven.dependency.classpath">
            <include name="axiom-api/src/**/*.java"/>
            <include name="axiom-dom/src/**/*.java"/>
            <include name="axiom-impl/src/**/*.java"/>
        </javac>
    </postGoal>

    <postGoal name="jar">
        <mkdir dir="target/classes/META-INF"/>
        <jar destfile="target/axiom-api-${axiom.version}.jar">
            <ant:fileset dir="target/classes">
                <ant:exclude name="org/apache/axiom/soap/impl/llom/**"/>
                <ant:exclude name="org/apache/axiom/om/impl/llom/**"/>
                <ant:exclude name="org/apache/axiom/soap/impl/dom/**"/>
                <ant:exclude name="org/apache/axiom/om/impl/dom/**"/>
                <ant:include name="org/**"/>
            </ant:fileset>
            <ant:fileset dir="${basedir}">
                <ant:include name="LICENSE.txt"/>
                <ant:include name="NOTICE.txt"/>
            </ant:fileset>
        </jar>
        <jar destfile="target/axiom-impl-${axiom.version}.jar">
            <ant:fileset dir="target/classes">
                <ant:include name="org/apache/axiom/soap/impl/llom/**"/>
                <ant:include name="org/apache/axiom/om/impl/llom/**"/>
            </ant:fileset>
            <ant:fileset dir="${basedir}">
                <ant:include name="LICENSE.txt"/>
                <ant:include name="NOTICE.txt"/>
            </ant:fileset>
        </jar>
        <jar destfile="target/axiom-dom-${axiom.version}.jar">
            <ant:fileset dir="target/classes">
                <ant:include name="org/apache/axiom/soap/impl/dom/**"/>
                <ant:include name="org/apache/axiom/om/impl/dom/**"/>
            </ant:fileset>
            <ant:fileset dir="${basedir}">
                <ant:include name="LICENSE.txt"/>
                <ant:include name="NOTICE.txt"/>
            </ant:fileset>
            <ant:fileset dir="${basedir}/modules/axiom-dom/src/main/resources">
                <ant:include name="**/*.properties"/>
            </ant:fileset>
        </jar>
        <ant:copy toDir="${maven.repo.local}/org.apache.ws.commons.axiom/jars">
            <ant:fileset file="target/axiom-api-${axiom.version}.jar"/>
            <ant:fileset file="target/axiom-impl-${axiom.version}.jar"/>
            <ant:fileset file="target/axiom-dom-${axiom.version}.jar"/>
        </ant:copy>

    </postGoal>

    <goal name="jar">
        <attainGoal name="jar:install"/>

    </goal>

    <goal name="release" prereqs="dist-bin,dist-src">


    </goal>

    <goal name="dist-bin" prereqs="jar">

        <ant:echo>+----------------------------------------------</ant:echo>
        <ant:echo>| Creating: Axiom Binary Distribution</ant:echo>
        <ant:echo>+----------------------------------------------</ant:echo>


        <property name="dist" value="target/dist/temp"/>

        <mkdir dir="${dist}"/>
        <mkdir dir="${dist}/apidocs"/>
        <mkdir dir="${dist}/build"/>
        <mkdir dir="${dist}/lib"/>

        <!--copy dependent jars-->
        <maven:reactor basedir="${basedir}"
                       postProcessing="true"
                       includes="project.xml"
                       banner="Executing (${goals}):"
                       ignoreFailures="false"/>
        <j:forEach var="x" items="${reactorProjects}">
            <ant:echo message="Copying ${x} to ${dist}"/>
            <deploy:copy-deps todir="${dist}/lib"
                              projectDescriptor="${x.getFile()}"/>
        </j:forEach>
        <ant:delete file="${dist}/lib/xmlunit-${xmlunit.version}.jar"/>
	<ant:delete file="${dist}/lib/junit-${junit.version}.jar"/>

        <!--Add the licenses of jars-->
        <ant:copy toDir="${dist}/lib">
            <ant:fileset dir="legal"/>
        </ant:copy>

        <!--add api docs-->

        <ant:javadoc packagenames="org.apache.axiom.*"
                     defaultexcludes="yes"
                     destdir="${dist}/apidocs"
                     author="true"
                     breakiterator="true"
                     version="true"
                     use="true"
                     windowtitle="AXIOM API">
            <ant:arg
                    line="-J-Dhttp.proxy.port=${maven.proxy.port} -J-Dhttp.proxy.host=${maven.proxy.host}"/>

            <ant:sourcepath>
                <ant:pathelement location="modules/axiom-impl/src/main/java"/>
                <ant:pathelement location="modules/axiom-dom/src/main/java"/>
                <ant:pathelement location="modules/axiom-api/src/main/java"/>
            </ant:sourcepath>
            <ant:classpath>
                <ant:fileset dir="${dist}/lib">
                    <ant:include name="*.jar"/>
		</ant:fileset>
            </ant:classpath>
        </ant:javadoc>

        <!--add jars-->
        <ant:copy toDir="${dist}/build">
            <ant:fileset file="target/axiom-api-${axiom.version}.jar"/>
            <ant:fileset file="target/axiom-impl-${axiom.version}.jar"/>
            <ant:fileset file="target/axiom-dom-${axiom.version}.jar"/>
        </ant:copy>

        <!--add documents-->
        <ant:copy toDir="${dist}/docs">
            <ant:fileset dir="src/site">
                <ant:exclude name="**/.svn/**"/>
                <ant:include name="resources/*"/>
                <ant:include name="xdoc/**/*"/>
            </ant:fileset>
        </ant:copy>

        <!--copy release notes, etc-->
        <ant:copy toDir="${dist}">
            <ant:fileset file="RELEASE-NOTE.txt"/>
            <ant:fileset file="README.txt"/>
            <ant:fileset file="NOTICE.txt"/>
            <ant:fileset file="LICENSE.txt"/>
        </ant:copy>


        <!--create the zip-->
        <ant:zip file="target/dist/axiom-${axiom.version}-bin.zip">
            <ant:fileset dir="${dist}/"/>
        </ant:zip>

        <ant:delete dir="${dist}"/>

    </goal>

    <goal name="dist-src" prereqs="jar">

        <ant:echo>+----------------------------------------------</ant:echo>
        <ant:echo>| Creating: Axiom Source Distribution</ant:echo>
        <ant:echo>+----------------------------------------------</ant:echo>

        <ant:property name="dist" value="target/dist/temp"/>

        <ant:copy toDir="${dist}">
            <ant:fileset dir=".">
                <ant:exclude name="**/.svn/**"/>
                <ant:exclude name="**/target/**"/>
                <ant:include name="**/src/**"/>
                <ant:include name="**/test/**"/>
                <ant:include name="**/test-resources/**/*.*"/>
                <ant:include name="**/pom.xml"/>
            </ant:fileset>
        </ant:copy>

        <!-- Copy the master maven files for the standard src distro -->
        <ant:copy toDir="${dist}">
            <ant:fileset file="maven.xml"/>
            <ant:fileset file="project.xml"/>
            <ant:fileset file="project.properties"/>
            <ant:fileset file="pom.xml"/>
            <ant:fileset file="RELEASE-NOTE.txt"/>
            <ant:fileset file="NOTICE.txt"/>
            <ant:fileset file="LICENSE.txt"/>
        </ant:copy>

        <ant:copy toDir="${dist}">
            <ant:fileset dir=".">
                <ant:include name="legal/*.txt"/>
            </ant:fileset>
        </ant:copy>

        <ant:zip file="target/dist/axiom-${axiom.version}-src.zip">
            <ant:fileset dir="${dist}/"/>
        </ant:zip>
        <ant:delete dir="${dist}"/>
    </goal>

    <goal name="javadocs">

        <mkdir dir="target/apidocs"/>

        <ant:javadoc packagenames="org.apache.axiom.*"
                     defaultexcludes="yes"
                     destdir="target/apidocs"
                     author="true"
                     breakiterator="true"
                     version="true"
                     use="true"
                     windowtitle="AXIOM API">
            <ant:arg
                    line="-J-Dhttp.proxy.port=${maven.proxy.port} -J-Dhttp.proxy.host=${maven.proxy.host}"/>
            <ant:sourcepath>
                <ant:pathelement location="src"/>
            </ant:sourcepath>
        </ant:javadoc>
    </goal>

</project>
